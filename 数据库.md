# **æ•°æ®åº“é”**



## **2PLï¼šTwo-Phase Locking**

ä¼ ç»ŸRDBMSåŠ é”çš„ä¸€ä¸ªåŸåˆ™ï¼Œå°±æ˜¯2PL (äºŒé˜¶æ®µé”)ï¼š[Two-Phase Locking](http://en.wikipedia.org/wiki/Two-phase_locking)ã€‚ç›¸å¯¹è€Œè¨€ï¼Œ2PLæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œè¯´çš„æ˜¯é”æ“ä½œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š**åŠ é”é˜¶æ®µä¸è§£é”é˜¶æ®µ**ï¼Œå¹¶ä¸”**ä¿è¯åŠ é”é˜¶æ®µä¸è§£é”é˜¶æ®µä¸ç›¸äº¤**ã€‚ä¸‹é¢ï¼Œä»æ—§ä»¥MySQLä¸ºä¾‹ï¼Œæ¥ç®€å•çœ‹çœ‹2PLåœ¨MySQLä¸­çš„å®ç°

![image-20210917164223390](/Users/bytedance/Library/Application Support/typora-user-images/image-20210917164223390.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œ2PLå°±æ˜¯å°†åŠ é”/è§£é”åˆ†ä¸ºä¸¤ä¸ªå®Œå…¨ä¸ç›¸äº¤çš„é˜¶æ®µã€‚åŠ é”é˜¶æ®µï¼šåªåŠ é”ï¼Œä¸æ”¾é”ã€‚è§£é”é˜¶æ®µï¼šåªæ”¾é”ï¼Œä¸åŠ é”



## å¹»è¯»

## å®šä¹‰

å¹»è¯»æŒ‡çš„æ˜¯**ä¸€ä¸ªäº‹åŠ¡åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ—¶å€™**ï¼Œ**åä¸€æ¬¡æŸ¥è¯¢çœ‹åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰çœ‹åˆ°çš„è¡Œ**ã€‚è¿™é‡Œï¼Œæˆ‘éœ€è¦å¯¹â€œå¹»è¯»â€åšä¸€ä¸ªè¯´æ˜ï¼š

1. åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šçš„æŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ã€‚å› æ­¤ï¼Œ**å¹»è¯»åœ¨â€œå½“å‰è¯»â€ä¸‹æ‰ä¼šå‡ºç°**
2. **å¹»è¯»ä»…ä¸“æŒ‡â€œæ–°æ’å…¥çš„è¡Œ**â€

æœ¬æ–‡æ¥ä¸‹æ¥æ²¡æœ‰ç‰¹æ®Šè¯´æ˜çš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯è®¾å®šåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹

```sql
CREATE TABLE `t` (

  `id` int(11) NOT NULL, // æ²¡æœ‰auto_increment

  `c` int(11) DEFAULT NULL,

  `d` int(11) DEFAULT NULL,

  PRIMARY KEY (`id`),

  KEY `c` (`c`)

) ENGINE=InnoDB;



insert into t values(0,0,0),(5,5,5),

(10,10,10),(15,15,15),(20,20,20),(25,25,25);
```



|      | Session A                                                    | Session B                        | Session C                   |
| ---- | ------------------------------------------------------------ | -------------------------------- | --------------------------- |
| T1   | Begin; Select * from t where d = 5 for update;/*Q1*/ result:(5,5,5) |                                  |                             |
| T2   |                                                              | Update t set d = 5 where id = 0; |                             |
| T3   | Select * from t where d=5 for update;/*Q2*/ result:(0,0,5),(5,5,5) |                                  |                             |
| T4   |                                                              |                                  | Insert into t values(1,1,5) |
| T5   | Select * from t where d = 5 for update;/*Q3*/ result:(0,0,5),(1,1,5),(5,5,5) |                                  |                             |
| T6   | commit;                                                      |                                  |                             |

å‡è®¾åªåœ¨ id=5 è¿™ä¸€è¡ŒåŠ è¡Œé”

ä¸Šé¢ session B çš„ä¿®æ”¹ç»“æœï¼Œè¢« session A ä¹‹åçš„ select è¯­å¥ç”¨â€œå½“å‰è¯»â€çœ‹åˆ°ï¼Œä¸èƒ½ç§°ä¸ºå¹»è¯»

T5 è¯»åˆ° id=1 è¿™ä¸€è¡Œçš„ç°è±¡ï¼Œè¢«ç§°ä¸ºâ€œå¹»è¯»â€

é—®é¢˜:

1.**è¯­ä¹‰ä¸Šçš„é—®é¢˜**ï¼Œsession A åœ¨ T1 æ—¶åˆ»å°±å£°æ˜äº†ï¼Œâ€œæˆ‘è¦æŠŠæ‰€æœ‰ d=5 çš„è¡Œé”ä½ï¼Œä¸å‡†åˆ«çš„äº‹åŠ¡è¿›è¡Œè¯»å†™æ“ä½œâ€ã€‚è€Œå®é™…ä¸Šï¼Œè¿™ä¸ªè¯­ä¹‰è¢«ç ´åäº†

|      | Session A                                            | Session B                                                    | Session C                                                    |
| ---- | ---------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| T1   | Begin; Select * from t where d = 5 for update;/*Q1*/ |                                                              |                                                              |
| T2   |                                                      | Update t set d = 5 where id = 0; Update t set c = 5 where id = 0; |                                                              |
| T3   | Select * from t where d=5 for update;/*Q2*/          |                                                              |                                                              |
| T4   |                                                      |                                                              | Insert into t values(1,1,5); Update t set c = 5 where id = 1; |
| T5   | Select * from t where d = 5 for update;/*Q3*/        |                                                              |                                                              |
| T6   | commit;                                              |                                                              |                                                              |

å‡è®¾åªåœ¨ id=5 è¿™ä¸€è¡ŒåŠ è¡Œé” -- è¯­ä¹‰è¢«ç ´å

session B çš„ç¬¬äºŒæ¡è¯­å¥ update t set c=5 where id=0ï¼Œè¯­ä¹‰æ˜¯â€œæˆ‘æŠŠ id=0ã€d=5 è¿™ä¸€è¡Œçš„ c å€¼ï¼Œæ”¹æˆäº† 5â€ã€‚

ç”±äºåœ¨ T1 æ—¶åˆ»ï¼Œsession A è¿˜åªæ˜¯ç»™ id=5 è¿™ä¸€è¡ŒåŠ äº†è¡Œé”ï¼Œ å¹¶æ²¡æœ‰ç»™ id=0 è¿™è¡ŒåŠ ä¸Šé”ã€‚å› æ­¤ï¼Œsession B åœ¨ T2 æ—¶åˆ»ï¼Œæ˜¯å¯ä»¥æ‰§è¡Œè¿™ä¸¤æ¡ update è¯­å¥çš„ã€‚**è¿™æ ·ï¼Œå°±ç ´åäº†** **session** **A é‡Œ Q1 è¯­å¥è¦é”ä½æ‰€æœ‰ d=5 çš„è¡Œçš„åŠ é”å£°æ˜**



2.**æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜**ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œé”çš„è®¾è®¡æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚è€Œè¿™ä¸ªä¸€è‡´æ€§ï¼Œä¸æ­¢æ˜¯**æ•°æ®åº“å†…éƒ¨æ•°æ®çŠ¶æ€åœ¨æ­¤åˆ»çš„ä¸€è‡´æ€§**ï¼Œè¿˜åŒ…å«äº†**æ•°æ®å’Œæ—¥å¿—åœ¨é€»è¾‘ä¸Šçš„ä¸€è‡´æ€§**

ä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œç»™ session A åœ¨ T1 æ—¶åˆ»å†åŠ ä¸€ä¸ªæ›´æ–°è¯­å¥ï¼Œå³ï¼šupdate t set d=100 where d=5

|      | Session A                                                    | Session B                                                    | Session C                                                    |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| T1   | Begin; Select * from t where d = 5 for update;/*Q1*/ Update t set d = 100 where d = 5; |                                                              |                                                              |
| T2   |                                                              | Update t set d = 5 where id = 0; Update t set c = 5 where id = 0; |                                                              |
| T3   | Select * from t where d=5 for update;/*Q2*/                  |                                                              |                                                              |
| T4   |                                                              |                                                              | Insert into t values(1,1,5); Update t set c = 5 where id = 1; |
| T5   | Select * from t where d = 5 for update;/*Q3*/                |                                                              |                                                              |
| T6   | commit;                                                      |                                                              |                                                              |

å‡è®¾åªåœ¨ id=5 è¿™ä¸€è¡ŒåŠ è¡Œé” -- æ•°æ®ä¸€è‡´æ€§é—®é¢˜

update çš„åŠ é”è¯­ä¹‰å’Œ select â€¦for update æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™åŠ ä¸Šè¿™æ¡ update è¯­å¥ä¹Ÿå¾ˆåˆç†ã€‚session A å£°æ˜è¯´â€œè¦ç»™ d=5 çš„è¯­å¥åŠ ä¸Šé”â€ï¼Œå°±æ˜¯ä¸ºäº†è¦æ›´æ–°æ•°æ®ï¼Œæ–°åŠ çš„è¿™æ¡ update è¯­å¥å°±æ˜¯æŠŠå®ƒè®¤ä¸ºåŠ ä¸Šäº†é”çš„è¿™ä¸€è¡Œçš„ d å€¼ä¿®æ”¹æˆäº† 100

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å›¾ 3 æ‰§è¡Œå®Œæˆåï¼Œæ•°æ®åº“é‡Œä¼šæ˜¯ä»€ä¹ˆç»“æœã€‚

1. ç»è¿‡ T1 æ—¶åˆ»ï¼Œid=5 è¿™ä¸€è¡Œå˜æˆ (5,5,100)ï¼Œå½“ç„¶è¿™ä¸ªç»“æœæœ€ç»ˆæ˜¯åœ¨ T6 æ—¶åˆ»æ­£å¼æäº¤çš„ 
2. ç»è¿‡ T2 æ—¶åˆ»ï¼Œid=0 è¿™ä¸€è¡Œå˜æˆ (0,5,5)
3. ç»è¿‡ T4 æ—¶åˆ»ï¼Œè¡¨é‡Œé¢å¤šäº†ä¸€è¡Œ (1,5,5)
4. å…¶ä»–è¡Œè·Ÿè¿™ä¸ªæ‰§è¡Œåºåˆ—æ— å…³ï¼Œä¿æŒä¸å˜

è¿™æ ·çœ‹ï¼Œè¿™äº›æ•°æ®ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ—¶å€™ binlog é‡Œé¢çš„å†…å®¹

1. T2 æ—¶åˆ»ï¼Œsession B äº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›
2. T4 æ—¶åˆ»ï¼Œsession C äº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›
3. T6 æ—¶åˆ»ï¼Œsession A äº‹åŠ¡æäº¤ï¼Œå†™å…¥äº† update t set d=100 where d=5 è¿™æ¡è¯­å¥ã€‚

ç»Ÿä¸€æ”¾åˆ°ä¸€èµ·çš„è¯ï¼Œå°±æ˜¯è¿™æ ·çš„ï¼š

```
B:update t set d=5 where id=0; /*(0,0,5)*/

B:update t set c=5 where id=0; /*(0,5,5)*/



C:insert into t values(1,1,5); /*(1,1,5)*/

C:update t set c=5 where id=1; /*(1,5,5)*/



A:update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/
```

è¿™ä¸ªè¯­å¥åºåˆ—ï¼Œä¸è®ºæ˜¯æ‹¿åˆ°å¤‡åº“å»æ‰§è¡Œï¼Œè¿˜æ˜¯ä»¥åç”¨ binlog æ¥å…‹éš†ä¸€ä¸ªåº“ï¼Œè¿™ä¸‰è¡Œçš„ç»“æœï¼Œéƒ½å˜æˆäº† (0,5,100)ï¼ˆä¸»åº“æ˜¯(0,5,5)ï¼‰ã€(1,5,100)(ä¸»åº“æ˜¯(1,5,5)) å’Œ (5,5,100)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**id=0 å’Œ id=1 è¿™ä¸¤è¡Œï¼Œå‘ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´**

åˆ†æä¸€ä¸‹å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯æˆ‘ä»¬å‡è®¾â€œselect * from t where d=5 for update è¿™æ¡è¯­å¥åªç»™ d=5 è¿™ä¸€è¡Œï¼Œä¹Ÿå°±æ˜¯ id=5 çš„è¿™ä¸€è¡ŒåŠ é”â€å¯¼è‡´çš„



æˆ‘ä»¬**æŠŠæ‰«æè¿‡ç¨‹ä¸­ç¢°åˆ°çš„è¡Œï¼Œä¹Ÿéƒ½åŠ ä¸Šå†™é”**ï¼Œå†æ¥çœ‹çœ‹æ‰§è¡Œæ•ˆæœ

|      | Session A                                                    | Session B                                                    | Session C                                                    |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| T1   | Begin; Select * from t where d = 5 for update;/*Q1*/ Update t set d=100 where d=5; |                                                              |                                                              |
| T2   |                                                              | Update t set d = 5 where id = 0; (blocked) Update t set c = 5 where id = 0; |                                                              |
| T3   | Select * from t where d=5 for update;/*Q2*/                  |                                                              |                                                              |
| T4   |                                                              |                                                              | Insert into t values(1,1,5); Update t set c = 5 where id = 1; |
| T5   | Select * from t where d = 5 for update;/*Q3*/                |                                                              |                                                              |
| T6   | commit;                                                      |                                                              |                                                              |

å‡è®¾æ‰«æåˆ°çš„è¡Œéƒ½è¢«åŠ ä¸Šäº†è¡Œé”

ç”±äº session A æŠŠæ‰€æœ‰çš„è¡Œéƒ½åŠ äº†å†™é”ï¼Œæ‰€ä»¥ session B åœ¨æ‰§è¡Œç¬¬ä¸€ä¸ª update è¯­å¥çš„æ—¶å€™å°±è¢«é”ä½äº†ã€‚éœ€è¦ç­‰åˆ° T6 æ—¶åˆ» session A æäº¤ä»¥åï¼Œsession B æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

è¿™æ ·å¯¹äº id=0 è¿™ä¸€è¡Œï¼Œåœ¨æ•°æ®åº“é‡Œçš„æœ€ç»ˆç»“æœè¿˜æ˜¯ (0,5,5)ã€‚

åœ¨ binlog é‡Œé¢ï¼Œæ‰§è¡Œåºåˆ—æ˜¯è¿™æ ·çš„ï¼š

```
C:insert into t values(1,1,5); /*(1,1,5)*/

C:update t set c=5 where id=1; /*(1,5,5)*/



A:update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/



B:update t set d=5 where id=0; /*(0,0,5)*/

B:update t set c=5 where id=0; /*(0,5,5)*/
```

å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§æ—¥å¿—é¡ºåºæ‰§è¡Œï¼Œid=0 è¿™ä¸€è¡Œçš„æœ€ç»ˆç»“æœä¹Ÿæ˜¯ (0,5,5)ã€‚æ‰€ä»¥ï¼Œid=0 è¿™ä¸€è¡Œçš„é—®é¢˜è§£å†³äº†

ä½†åŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œid=1 è¿™ä¸€è¡Œï¼Œåœ¨æ•°æ®åº“é‡Œé¢çš„ç»“æœæ˜¯ (1,5,5)ï¼Œè€Œæ ¹æ® binlog çš„æ‰§è¡Œç»“æœæ˜¯ (1,5,100)ï¼Œä¹Ÿå°±æ˜¯è¯´å¹»è¯»çš„é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬å·²ç»è¿™ä¹ˆâ€œå‡¶æ®‹â€åœ°ï¼ŒæŠŠæ‰€æœ‰çš„è®°å½•éƒ½ä¸Šäº†é”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº† id=1 è¿™ä¸€è¡Œçš„æ’å…¥å’Œæ›´æ–°å‘¢ï¼Ÿ

åŸå› å¾ˆç®€å•ã€‚åœ¨ T3 æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™æ‰€æœ‰è¡ŒåŠ é”çš„æ—¶å€™ï¼Œid=1 è¿™ä¸€è¡Œè¿˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¹Ÿå°±åŠ ä¸ä¸Šé”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å³ä½¿æŠŠæ‰€æœ‰çš„è®°å½•éƒ½åŠ ä¸Šé”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†æ–°æ’å…¥çš„è®°å½•**



## å¦‚ä½•è§£å†³å¹»è¯»

äº§ç”Ÿå¹»è¯»çš„åŸå› æ˜¯ï¼Œè¡Œé”åªèƒ½é”ä½è¡Œï¼Œä½†æ˜¯æ–°æ’å…¥è®°å½•è¿™ä¸ªåŠ¨ä½œï¼Œè¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼ŒInnoDB åªå¥½å¼•å…¥æ–°çš„é”ï¼Œä¹Ÿå°±æ˜¯**é—´éš™é”** (Gap Lock)



é¡¾åæ€ä¹‰ï¼Œé—´éš™é”ï¼Œé”çš„å°±æ˜¯ä¸¤ä¸ªå€¼ä¹‹é—´çš„ç©ºéš™ã€‚æ¯”å¦‚æ–‡ç« å¼€å¤´çš„è¡¨ tï¼Œåˆå§‹åŒ–æ’å…¥äº† 6 ä¸ªè®°å½•ï¼Œè¿™å°±äº§ç”Ÿäº† 7 ä¸ªé—´éš™

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=OTE0NjI3NWY5OWFkNGUzMGQ5N2MwZGM2MWM5OGUwYjhfbXZBTW54VXNtNTQzZDBTRU1nbmZpdW5IdGFrRENCWjlfVG9rZW46Ym94Y256OWRFNDNoc0F3V0RSU1VJczlvZXBjXzE2MzE4NjkyMDY6MTYzMTg3MjgwNl9WNA)

å›¾ 5 è¡¨ t ä¸»é”®ç´¢å¼•ä¸Šçš„è¡Œé”å’Œé—´éš™é”

è¿™æ ·ï¼Œå½“æ‰§è¡Œ select * from t where d=5 for update çš„æ—¶å€™ï¼Œå°±ä¸æ­¢æ˜¯ç»™æ•°æ®åº“ä¸­å·²æœ‰çš„ 6 ä¸ªè®°å½•åŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜åŒæ—¶åŠ äº† 7 ä¸ªé—´éš™é”ã€‚è¿™æ ·å°±ç¡®ä¿äº†æ— æ³•å†æ’å…¥æ–°çš„è®°å½•ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™ï¼Œåœ¨ä¸€è¡Œè¡Œæ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä»…å°†ç»™è¡ŒåŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜ç»™è¡Œä¸¤è¾¹çš„ç©ºéš™ï¼Œä¹ŸåŠ ä¸Šäº†é—´éš™é”



è·Ÿè¡Œé”æœ‰å†²çªå…³ç³»çš„æ˜¯â€œå¦å¤–ä¸€ä¸ªè¡Œé”â€ã€‚ä½†æ˜¯é—´éš™é”ä¸ä¸€æ ·ï¼Œ**è·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œ(Insert Intention Lock)ã€‚é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»**



**é—´éš™é”å’Œè¡Œé”åˆç§° next-key lockï¼Œæ¯ä¸ª next-key lock æ˜¯å‰å¼€åé—­åŒºé—´**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„è¡¨ t åˆå§‹åŒ–ä»¥åï¼Œå¦‚æœç”¨ select * from t for update è¦æŠŠæ•´ä¸ªè¡¨æ‰€æœ‰è®°å½•é”èµ·æ¥ï¼Œå°±å½¢æˆäº† 7 ä¸ª next-key lockï¼Œåˆ†åˆ«æ˜¯ (-âˆ,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20, 25]ã€(25, +supremum]



## é—´éš™é”çš„å›°æ‰°

| Session A                                                    | Session B                                     |
| ------------------------------------------------------------ | --------------------------------------------- |
| Begin; Select * from t where id=9 for update;                |                                               |
|                                                              | Begin; Select * from t where id=9 for update; |
|                                                              | Insert into t values(9,9,9); (blocked)        |
| Insert into t values(9,9,9); (ERROR 1213(40001):Deadlock found) |                                               |

**é—´éš™é”å¯¼è‡´çš„æ­»é”**

ç”±äº id=9 è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼ŒSession Aå’Œ Session Bçš„ç¬¬ä¸€è¡Œè¯­å¥å› æ­¤ä¼šåŠ ä¸Šé—´éš™é” (5,10)

é—´éš™é”çš„å¼•å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒæ ·çš„è¯­å¥é”ä½æ›´å¤§çš„èŒƒå›´ï¼Œ**è¿™å…¶å®æ˜¯å½±å“äº†å¹¶å‘åº¦çš„**



**é—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆçš„**ã€‚æ‰€ä»¥ï¼Œå¦‚æœæŠŠéš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¯»æäº¤çš„è¯ï¼Œå°±æ²¡æœ‰é—´éš™é”äº†ã€‚ ä½†åŒæ—¶ï¼Œè¦**è§£å†³å¯èƒ½å‡ºç°çš„æ•°æ®å’Œæ—¥å¿—ä¸ä¸€è‡´é—®é¢˜**ï¼Œ**éœ€è¦æŠŠ binlog æ ¼å¼è®¾ç½®ä¸º row**ã€‚è¿™ï¼Œä¹Ÿæ˜¯ç°åœ¨ä¸å°‘å…¬å¸ä½¿ç”¨çš„é…ç½®ç»„åˆ(æˆ‘ä»¬å…¬å¸å°±æ˜¯è¿™æ ·åšçš„)



##### binlog æ ¼å¼

- **statement**ï¼š**åŸºäºSQLè¯­å¥çš„æ¨¡å¼**ï¼ŒæŸäº›è¯­å¥å’Œå‡½æ•°å¦‚UUID, LOAD DATA INFILEç­‰åœ¨å¤åˆ¶è¿‡ç¨‹å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ç”šè‡³å‡ºé”™

- **row**ï¼š**åŸºäºè¡Œçš„æ¨¡å¼**ï¼Œè®°å½•çš„æ˜¯è¡Œçš„å˜åŒ–ï¼Œå¾ˆ**å®‰å…¨**ã€‚ä½†æ˜¯binlogä¼šæ¯”å…¶ä»–ä¸¤ç§æ¨¡å¼å¤§å¾ˆå¤šï¼Œ**åœ¨ä¸€äº›å¤§è¡¨ä¸­æ¸…é™¤å¤§é‡æ•°æ®æ—¶åœ¨binlogä¸­ä¼šç”Ÿæˆå¾ˆå¤šæ¡è¯­å¥ï¼Œå¯èƒ½å¯¼è‡´ä»åº“å»¶è¿Ÿå˜å¤§**

- mixedï¼šæ··åˆæ¨¡å¼ï¼Œæ ¹æ®è¯­å¥æ¥é€‰ç”¨æ˜¯statementè¿˜æ˜¯rowæ¨¡å¼

ä¸¾ä¸ªğŸŒ°ï¼Œ åˆ é™¤æ“ä½œ statementæ ¼å¼è®°å½•çš„æ˜¯è¿™ä¸ªåˆ é™¤çš„è¯­å¥ï¼Œä¾‹å¦‚ï¼š delete from t where age>10 and modified_time<='2020-03-04' limit 1 è€Œrowæ ¼å¼è®°å½•çš„æ˜¯**å®é™…å—å½±å“çš„æ•°æ®æ˜¯çœŸå®åˆ é™¤è¡Œçš„ä¸»é”®id**ï¼Œä¾‹å¦‚ï¼š delete from t where id=3 and age=12 and modified_time='2020-03-04'



# åŠ é”è§„åˆ™ï¼ˆRCçº§åˆ«æ— é—´éš™é”ï¼‰

- **åŸåˆ™ 1ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lockï¼ˆåˆ†ææ—¶è¿™æ ·çœ‹ï¼Œå…·ä½“æ‰§è¡Œçš„æ—¶å€™ï¼Œæ˜¯è¦åˆ†æˆé—´éš™é”å’Œè¡Œé”ä¸¤æ®µæ¥æ‰§è¡Œçš„ï¼‰ã€‚next-key lock æ˜¯å‰å¼€åé—­åŒºé—´**
- **åŸåˆ™ 2ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”**
- **ä¼˜åŒ– 1ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œç»™å”¯ä¸€ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œnext-key lock é€€åŒ–ä¸ºè¡Œé”**
- **ä¼˜åŒ– 2ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„æ—¶å€™ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é”**
- **ä¸€ä¸ª bugï¼šå”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢(mysql 8.0.18ç‰ˆæœ¬ ä¸»é”®å·²ç»ä¿®å¤ï¼Œå”¯ä¸€ç´¢å¼•æ²¡æœ‰ä¿®å¤)**



ä»¥è¡¨tä¸ºä¾‹ï¼Œå»ºè¡¨è¯­å¥å’Œåˆå§‹åŒ–è¯­å¥å¦‚ä¸‹

```sql
CREATE TABLE `t` (

  `id` int(11) NOT NULL,

  `c` int(11) DEFAULT NULL,

  `d` int(11) DEFAULT NULL,

  PRIMARY KEY (`id`),

  KEY `c` (`c`)

) ENGINE=InnoDB;



insert into t values(0,0,0),(5,5,5),

(10,10,10),(15,15,15),(20,20,20),(25,25,25);
```

 åˆ†æä¸€æ¡sqlè¯­å¥çš„åŠ é”æƒ…å†µï¼Œéœ€è¦ä¸€äº›å‰ææ¡ä»¶

-  **å‰æä¸€ï¼š**å½“å‰ç³»ç»Ÿçš„éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

-  **å‰æäºŒï¼š**SQLçš„æ‰§è¡Œè®¡åˆ’æ˜¯ä»€ä¹ˆï¼Ÿç´¢å¼•æ‰«æï¼Ÿå…¨è¡¨æ‰«æï¼Ÿ

-  **å‰æä¸‰ï¼š**å¦‚æœæ˜¯ç´¢å¼•æ‰«æï¼Œè¿™ä¸ªç´¢å¼•æ˜¯ä¸»é”®ç´¢å¼•ï¼Œè¿˜æ˜¯æ™®é€šç´¢å¼•ï¼Ÿå¦‚æœæ˜¯æ™®é€šç´¢å¼•ï¼Œé‚£æ˜¯å¦æ˜¯å”¯ä¸€ç´¢å¼•

ä»¥ä¸‹åˆ†æå‡å‡å®šåœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œå¹¶ä¸”å‡å®šæ‰§è¡Œè®¡åˆ’èµ°å¯¹åº”çš„ç´¢å¼•

## æ¡ˆä¾‹ä¸€ï¼šå”¯ä¸€ç´¢å¼• ç­‰å€¼æŸ¥è¯¢ è®°å½•å­˜åœ¨

| Session A                                    | Session B                               |
| -------------------------------------------- | --------------------------------------- |
| Begin; Update t set d = d + 1 where id = 10; | Insert into t values(8,8,8); (query ok) |

é¦–å…ˆä¼šåœ¨ä¸»é”®ç´¢å¼•ä¸Šå®šä½åˆ°id = 10è¿™æ¡è®°å½•ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢ï¼Œæ ¹æ®ä¼˜åŒ–ä¸€ï¼Œæ‰€ä»¥next-key lockä¼šé€€åŒ–ä¸ºè¡Œé”ï¼Œå³åªä¼šåœ¨id = 10ä¸ŠåŠ è¡Œé”



## æ¡ˆä¾‹äºŒï¼šå”¯ä¸€ç´¢å¼• ç­‰å€¼æŸ¥è¯¢ è®°å½•ä¸å­˜åœ¨

| Session A                                   | Session B                              | Sesion C                                     |
| ------------------------------------------- | -------------------------------------- | -------------------------------------------- |
| Begin; Update t set d = d + 1 where id  =7; |                                        |                                              |
|                                             | Insert into t values(8,8,8); (blocked) |                                              |
|                                             |                                        | Update t set d=d+1 where id = 10; (query ok) |

ç”±äºè¡¨ t ä¸­æ²¡æœ‰ id=7 çš„è®°å½•ï¼Œæ ¹æ®åŸåˆ™ 1ï¼ŒåŠ é”å•ä½æ˜¯ next-key lockï¼Œsession A åŠ é”èŒƒå›´å°±æ˜¯ (5,10]ï¼›åŒæ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢ (id=7)ï¼Œè€Œ id=10 ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œå‘å³éå†ï¼Œæ ¹æ®ä¼˜åŒ–äºŒï¼Œnext-key lock é€€åŒ–æˆé—´éš™é”ï¼Œå› æ­¤æœ€ç»ˆåŠ é”çš„èŒƒå›´æ˜¯ (5,10)ã€‚æ‰€ä»¥session Bé˜»å¡äº†ï¼Œsession Cæ‰§è¡ŒæˆåŠŸ



## æ¡ˆä¾‹ä¸‰ï¼šå”¯ä¸€ç´¢å¼• èŒƒå›´æŸ¥è¯¢

| Session A                                                    | Session B                                                    | Session C                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ----------------------------------------------- |
| Begin; Select * from t where id >= 10 and id < 11 for update; |                                                              |                                                 |
|                                                              | Insert into t values(8,8,8); (query ok) Insert into t values(13,13,13); (blocked) |                                                 |
|                                                              |                                                              | Update t set d = d + 1 where id = 15; (blocked) |

å°½ç®¡Session Aå’Œæ¡ˆä¾‹1çš„Session AæŸ¥è¯¢ç»“æœç›¸åŒï¼Œä½†æ˜¯åŠ é”ä¸åŒ

1. å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦æ‰¾åˆ°ç¬¬ä¸€ä¸ª id=10 çš„è¡Œï¼Œå› æ­¤æœ¬è¯¥æ˜¯ next-key lock(5,10]ã€‚ å› ä¸ºè¿™æ˜¯ä¸»é”® id ä¸Šçš„ç­‰å€¼æ¡ä»¶ï¼Œ**æ˜¯å½“åšç­‰å€¼æŸ¥è¯¢æ¥åˆ¤æ–­çš„**ï¼Œæ ¹æ®ä¼˜åŒ–ä¸€ï¼Œé€€åŒ–æˆè¡Œé”ï¼ŒåªåŠ äº† id=10 è¿™ä¸€è¡Œçš„è¡Œé”
2. èŒƒå›´æŸ¥æ‰¾å°±å¾€åç»§ç»­æ‰¾ï¼Œæ‰¾åˆ° id=15 è¿™ä¸€è¡Œåœä¸‹æ¥ï¼Œ**è¿™æ—¶ç”¨çš„æ˜¯èŒƒå›´æŸ¥è¯¢åˆ¤æ–­**ï¼Œå› æ­¤éœ€è¦åŠ  next-key lock(10,15]ã€‚æ‰€ä»¥ï¼Œsession A è¿™æ—¶å€™é”çš„èŒƒå›´å°±æ˜¯ä¸»é”®ç´¢å¼•ä¸Šï¼Œè¡Œé” id=10 å’Œ next-key lock(10,15]

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œmysql 8.0ç›¸å…³ç‰ˆæœ¬ä¸ä¼šåœ¨id = 15ä¸ŠåŠ è¡Œé”äº†ï¼Œå³é€€åŒ–ä¸ºé—´éš™é”



## æ¡ˆä¾‹å››ï¼šå”¯ä¸€ç´¢å¼•ï¼ŒèŒƒå›´æŸ¥è¯¢2

| Session A                                                    | Session B                                                    | Session C                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------ |
| Begin; Select * from t where id > 9 and id < 12  **Order by id desc** for update; |                                                              |                                                  |
|                                                              | Insert into t values(8,8,8); (blocked) Insert into t values(13,13,13); (blocked) Update t set d = d + 1 where id =5; (blocked) |                                                  |
|                                                              |                                                              | Update t set d = d + 1 where id = 15; (query ok) |

1. é¦–å…ˆè¿™ä¸ªæŸ¥è¯¢è¯­å¥çš„è¯­ä¹‰æ˜¯ order by id descï¼Œè¦æ‹¿åˆ°æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰è¡Œï¼Œä¼˜åŒ–å™¨å¿…é¡»å…ˆæ‰¾åˆ°â€œç¬¬ä¸€ä¸ª id<12 çš„å€¼â€ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ç´¢å¼•æ ‘çš„æœç´¢è¿‡ç¨‹å¾—åˆ°çš„ï¼Œåœ¨å¼•æ“å†…éƒ¨ï¼Œå…¶å®æ˜¯è¦æ‰¾åˆ° id=12 çš„è¿™ä¸ªå€¼ï¼Œåªæ˜¯æœ€ç»ˆæ²¡æ‰¾åˆ°ï¼Œä½†æ‰¾åˆ°äº† (10,15) è¿™ä¸ªé—´éš™
2. å› æ­¤é¦–å…ˆä¼šå®šä½åˆ°id = 15è¿™æ¡è®°å½•ï¼Œå› ä¸ºåŠ é”å•ä½æ˜¯ next-key lockï¼Œéƒ½æ˜¯å‰å¼€åé—­åŒºé—´ï¼Œ**è¿™é‡Œæ˜¯ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢**ï¼Œå‘å³éå†çš„æ—¶å€™ id=15 ä¸æ»¡è¶³æ¡ä»¶ï¼Œæ ¹æ®ä¼˜åŒ–äºŒï¼Œæ‰€ä»¥ next-key lock é€€åŒ–ä¸ºäº†é—´éš™é” (10, 15)
3. ç„¶åå‘å·¦éå†ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­ï¼Œå°±ä¸æ˜¯ç­‰å€¼æŸ¥è¯¢äº†ï¼Œä¼šä¸€ç›´æ‰«æåˆ° id=5 è¿™ä¸€è¡Œï¼Œæ‰€ä»¥ä¼šåŠ ä¸€ä¸ª next-key lock (0,5]

å› æ­¤è¿™ä¸ªè¯­å¥çš„åŠ é”èŒƒå›´æ˜¯ä¸»é”®ç´¢å¼•ä¸Šçš„ (0,5]ã€(5,10]å’Œ (10, 15)



## æ¡ˆä¾‹äº”ï¼šæ™®é€šç´¢å¼•ï¼Œç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•å­˜åœ¨

| Session A                                              | Session B                                        | Session C                               |
| ------------------------------------------------------ | ------------------------------------------------ | --------------------------------------- |
| Begin; Select * from t where c = 5 lock in share mode; |                                                  |                                         |
|                                                        | Update t set d = d +  1 where id  =5; (query ok) |                                         |
|                                                        |                                                  | Insert into t values(7,7,7); (blockedï¼‰ |

1. é¦–å…ˆä¼šå®šä½åˆ°cç´¢å¼•ä¸Šc = 5 è¿™æ¡è®°å½•ï¼ŒåŠ é”å•ä½æ˜¯ next-key lockï¼Œå› æ­¤ä¼šç»™ (0,5]åŠ ä¸Š next-key lock
2. è¦æ³¨æ„ c æ˜¯æ™®é€šç´¢å¼•ï¼Œå› æ­¤ä»…è®¿é—® c=5 è¿™ä¸€æ¡è®°å½•æ˜¯ä¸èƒ½é©¬ä¸Šåœä¸‹æ¥çš„ï¼Œéœ€è¦å‘å³éå†ï¼ŒæŸ¥åˆ° c=10 æ‰æ”¾å¼ƒã€‚è®¿é—®åˆ°çš„éƒ½è¦åŠ é”ï¼Œå› æ­¤è¦ç»™ (5,10]åŠ  next-key lockã€‚ä½†æ˜¯åŒæ—¶è¿™é‡Œæ˜¯ç­‰å€¼åˆ¤æ–­ï¼Œå‘å³éå†ï¼Œæœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ c=5 è¿™ä¸ªç­‰å€¼æ¡ä»¶ï¼Œæ ¹æ®ä¼˜åŒ–äºŒï¼Œé€€åŒ–æˆé—´éš™é” (5,10)
3. æ ¹æ®åŸåˆ™ 2 ï¼Œåªæœ‰è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ï¼Œè¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¹¶ä¸éœ€è¦è®¿é—®ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä¸»é”®ç´¢å¼•ä¸Šæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ session B çš„ update è¯­å¥å¯ä»¥æ‰§è¡Œå®Œæˆ
4. éœ€è¦æ³¨æ„ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œlock in share mode åªé”è¦†ç›–ç´¢å¼•ï¼Œä½†æ˜¯å¦‚æœæ˜¯ for update å°±ä¸ä¸€æ ·äº†ã€‚ æ‰§è¡Œ for update æ—¶ï¼Œç³»ç»Ÿä¼šè®¤ä¸ºæ¥ä¸‹æ¥è¦æ›´æ–°æ•°æ®ï¼Œå› æ­¤ä¼šé¡ºä¾¿ç»™ä¸»é”®ç´¢å¼•ä¸Šæ»¡è¶³æ¡ä»¶çš„è¡ŒåŠ ä¸Šè¡Œé”



## æ¡ˆä¾‹å…­ï¼šæ™®é€šç´¢å¼•ï¼Œç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•ä¸å­˜åœ¨

| Session A                                               | Session B                                        | Session C                               |
| ------------------------------------------------------- | ------------------------------------------------ | --------------------------------------- |
| Begin; Select id from t where c = 7 lock in share mode; |                                                  |                                         |
|                                                         | Update t set d = d +  1 where id  =5; (query ok) |                                         |
|                                                         |                                                  | Insert into t values(7,7,7); (blockedï¼‰ |

ç”±äºè¡¨ t ä¸­æ²¡æœ‰ c=7 çš„è®°å½•ï¼Œå½“åœ¨cç´¢å¼•ä¸Šæ‰«æåˆ°c = 10æ—¶ï¼Œæ ¹æ®åŸåˆ™ 1ï¼ŒåŠ é”å•ä½æ˜¯ next-key lockï¼Œsession A åŠ é”èŒƒå›´å°±æ˜¯ (5,10]ï¼›åŒæ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢ (c=7)ï¼Œè€Œ c = 10 ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œnext-key lock é€€åŒ–æˆé—´éš™é”ï¼Œå› æ­¤æœ€ç»ˆåŠ é”çš„èŒƒå›´æ˜¯ (5,10)



## æ¡ˆä¾‹ä¸ƒï¼šæ™®é€šç´¢å¼•ï¼ŒèŒƒå›´æŸ¥è¯¢

| Session A                                                   | Session B                              | Session C                                    |
| ----------------------------------------------------------- | -------------------------------------- | -------------------------------------------- |
| Begin; Select * from t where c >= 10 and c < 11 for update; |                                        |                                              |
|                                                             | Insert into t values(8,8,8); (blocked) |                                              |
|                                                             |                                        | Update t set d = d+1 where c = 15; (blocked) |

1. è¿™æ¬¡ session A ç”¨å­—æ®µ c æ¥åˆ¤æ–­ï¼ŒåŠ é”è§„åˆ™è·Ÿæ¡ˆä¾‹ä¸‰å”¯ä¸€çš„ä¸åŒæ˜¯ï¼šåœ¨ç¬¬ä¸€æ¬¡ç”¨ c=10 å®šä½è®°å½•çš„æ—¶å€™ï¼Œç´¢å¼• c ä¸ŠåŠ äº† (5,10]è¿™ä¸ª next-key lock åï¼Œç”±äºç´¢å¼• c æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œæ²¡æœ‰ä¼˜åŒ–è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šèœ•å˜ä¸ºè¡Œé”ï¼Œå› æ­¤æœ€ç»ˆ sesion A åŠ çš„é”æ˜¯ï¼Œç´¢å¼• c ä¸Šçš„ (5,10] å’Œ (10,15] è¿™ä¸¤ä¸ª next-key lockï¼Œä»¥åŠç´¢å¼•idä¸Šçš„id = 10è¿™ä¸ªè¡Œé”(æ ¹æ®åŸåˆ™äºŒï¼Œå› ä¸ºä¸ç”¨åœ¨ä¸»é”®ç´¢å¼•ä¸Šè®¿é—®id =15,æ‰€ä»¥id = 15ä¸ä¼šåŠ é”)ã€‚
2. æ‰€ä»¥ä»ç»“æœä¸Šæ¥çœ‹ï¼Œsesson B è¦æ’å…¥ï¼ˆ8,8,8) çš„è¿™ä¸ª insert è¯­å¥æ—¶å°±è¢«å µä½äº†ã€‚
3. è¿™é‡Œéœ€è¦æ‰«æåˆ° c=15 æ‰åœæ­¢æ‰«æï¼Œæ˜¯åˆç†çš„ï¼Œå› ä¸º InnoDB è¦æ‰«åˆ° c=15ï¼Œæ‰çŸ¥é“ä¸éœ€è¦ç»§ç»­å¾€åæ‰¾äº†,è€Œä¸”è¿™é‡Œç”¨çš„æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œå³ä¸ä¼šé€€åŒ–ä¸ºé—´éš™é”



## æ¡ˆä¾‹å…«: ä¸èµ°ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ

 

| Session A                                      | Session B                                                    | Session C                                                    |
| ---------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Begin; Select * from t where d = 5 for update; |                                                              |                                                              |
|                                                | Insert into t values(8,8,8); (blocked) Insert into t values(2,2,2); (blocked) Insert into t values(28,28,28); (blocked) |                                                              |
|                                                |                                                              | Update t set d = d+1 where c = 15; (blocked) Update t set d = d+1 where c = 10; (blocked) Update t set d = d + 1 where id = 8; (query ok) |

1. ä½¿ç”¨d = 5è¿‡æ»¤ï¼Œç”±äºdåˆ—ä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šè¿›è¡Œå…¨è¡¨æ‰«æï¼Œè¿™æ—¶å¼•æ“ä¼šå°†æ‰€æœ‰è®°å½•è¿”å›ç»™MySQL serverå±‚è¿›è¡Œè¿‡æ»¤ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰è®°å½•éƒ½ä¼šåŠ next-key locké”
2.  åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¡¨ä¸Šï¼Œé™¤äº†ä¸åŠ é”çš„å¿«ç…§è¯»ï¼Œå…¶ä»–ä»»ä½•åŠ é”çš„å¹¶å‘SQLï¼Œå‡ä¸èƒ½æ‰§è¡Œï¼Œä¸èƒ½æ›´æ–°ï¼Œä¸èƒ½åˆ é™¤ï¼Œä¸èƒ½æ’å…¥ï¼Œå…¨è¡¨è¢«é”æ­», session cæœ€åé‚£æ¡sqlèƒ½å¤Ÿæ‰§è¡ŒæˆåŠŸï¼Œæ˜¯å› ä¸ºå…¶åªä¼šåœ¨idåˆ—ä¸Šçš„ï¼ˆ5ï¼Œ10ï¼‰åŠ é—´éš™é”ï¼Œé—´éš™é”æ˜¯ä¸å†²çªçš„
3. è¿™ä¸ªæƒ…å†µä¸‹ï¼ŒMySQLä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œå°±æ˜¯semi-consistent readã€‚semi-consistent readå¼€å¯çš„æƒ…å†µä¸‹ï¼Œåœ¨MySQL Serverè¿‡æ»¤æ¡ä»¶ï¼Œå‘ç°ä¸æ»¡è¶³åï¼Œä¼šè°ƒç”¨unlock_rowæ–¹æ³•ï¼ŒæŠŠä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•æ”¾é” (è¿èƒŒäº†2PLçš„çº¦æŸ)ã€‚é’ˆå¯¹ä¸Šé¢çš„è¿™ä¸ªç”¨ä¾‹ï¼Œå°±æ˜¯é™¤äº†è®°å½•[5ï¼Œ5ï¼Œ5]ä¹‹å¤–ï¼Œæ‰€æœ‰çš„è®°å½•é”éƒ½ä¼šè¢«é‡Šæ”¾ï¼ŒåŒæ—¶ä¸åŠ GAPé”
4. semi-consistent readå¦‚ä½•è§¦å‘ï¼šè¦ä¹ˆæ˜¯read committedéš”ç¦»çº§åˆ«ï¼›è¦ä¹ˆæ˜¯Repeatable Readéš”ç¦»çº§åˆ«ï¼ŒåŒæ—¶è®¾ç½®äº† [innodb_locks_unsafe_for_binlog](http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html) å‚æ•°ã€‚æ³¨ï¼šsemi-consistent readæœ¬èº«ä¹Ÿä¼šå¸¦æ¥å…¶ä»–é—®é¢˜ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚**mysql** **8.0å·²ç»æ²¡æœ‰è¿™ä¸ªå‚æ•°äº†**



# ä¸€äº›ç‰¹æ®ŠCaseçš„åŠ é”åˆ†æ

## Case 1 ä¸€ä¸ªbug

| Session A                                                    | Session B                                       | Session C                                 |
| ------------------------------------------------------------ | ----------------------------------------------- | ----------------------------------------- |
| Begin; select * from t where id > 10 and id <= 15 for update; |                                                 |                                           |
|                                                              | Update t set d = d + 1 where id = 20; (blocked) |                                           |
|                                                              |                                                 | Insert into t values(16,16,16); (blocked) |

1. æŒ‰ç…§åŸåˆ™ 1 çš„è¯ï¼Œåº”è¯¥æ˜¯ç´¢å¼• id ä¸ŠåªåŠ  (10,15]è¿™ä¸ª next-key lockï¼Œå¹¶ä¸”å› ä¸º id æ˜¯å”¯ä¸€é”®ï¼Œæ‰€ä»¥å¾ªç¯åˆ¤æ–­åˆ° id=15 è¿™ä¸€è¡Œå°±åº”è¯¥åœæ­¢äº†ã€‚
2. ä½†æ˜¯mysql 8.0.18 ä¹‹å‰çš„å®ç°ä¸Šï¼ŒInnoDB ä¼šå¾€å‰æ‰«æåˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„è¡Œä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯ id=20ã€‚è€Œä¸”ç”±äºè¿™æ˜¯ä¸ªèŒƒå›´æ‰«æï¼Œå› æ­¤ç´¢å¼• id ä¸Šçš„ (15,20]è¿™ä¸ª next-key lock ä¹Ÿä¼šè¢«é”ä¸Šã€‚**mysql** **8.0.18 ä¹‹åä¸ä¼šç»§ç»­å¾€åæ‰«æï¼Œä½†æ˜¯å¦‚æœidæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œè¿˜æ˜¯ä¼šç»§ç»­æ‰«æåˆ°id = 20**;

## Case 2 delete limit

å…ˆç»™è¡¨ t æ’å…¥ä¸€æ¡æ–°è®°å½•

```
insert into t values(30,10,30);
```

- Sql1: delete from t where c = 10;
- åˆ†æï¼šå‡è®¾é€‰æ‹©cåˆ—ä¸Šçš„ç´¢å¼•è¿›è¡Œæ¡ä»¶è¿‡æ»¤
  - éå†çš„æ—¶å€™ï¼Œå…ˆè®¿é—®ç¬¬ä¸€ä¸ª c=10 çš„è®°å½•ã€‚åŒæ ·åœ°ï¼Œæ ¹æ®åŸåˆ™ 1ï¼Œè¿™é‡ŒåŠ çš„æ˜¯ (c=5,id=5) åˆ° (c=10,id=10) è¿™ä¸ª next-key lockã€‚
  - ç„¶åï¼Œsession A å‘å³æŸ¥æ‰¾ï¼Œç›´åˆ°ç¢°åˆ° (c=15,id=15) è¿™ä¸€è¡Œï¼Œå¾ªç¯æ‰ç»“æŸã€‚æ ¹æ®ä¼˜åŒ–2ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³æŸ¥æ‰¾åˆ°äº†ä¸æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œæ‰€ä»¥ä¼šé€€åŒ–æˆ (c=10,id=10) åˆ° **(c=15,id=15)** çš„é—´éš™é”ã€‚
  - ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª delete è¯­å¥åœ¨ç´¢å¼• c ä¸Šçš„åŠ é”èŒƒå›´ï¼Œå°±æ˜¯ä¸‹å›¾ä¸­è“è‰²åŒºåŸŸè¦†ç›–çš„éƒ¨åˆ†ã€‚

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ODY0YTM2OWM2ZTQ2NzU0OTI1YjE3N2RmNjdiNjI0MzFfdGdTdHNiOEhENWdoZ3p2N1dIa1kyU3JHQk1uc1BHMENfVG9rZW46Ym94Y25UaHpQRXpnVldpZlM3a1ptQVFrMmRoXzE2MzE4NzAyMDA6MTYzMTg3MzgwMF9WNA)



- Sql2: delete from t where c = 10 limit 2;
- åˆ†æï¼šå‡è®¾é€‰æ‹©cåˆ—ä¸Šçš„ç´¢å¼•è¿›è¡Œæ¡ä»¶è¿‡æ»¤
  - è¿™ä¸ªä¾‹å­é‡Œï¼Œdelete è¯­å¥åŠ äº† limit 2ã€‚å› ä¸ºè¡¨ t é‡Œ c=10 çš„è®°å½•å…¶å®åªæœ‰ä¸¤æ¡ï¼Œå› æ­¤åŠ ä¸åŠ  limit 2ï¼Œåˆ é™¤çš„æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯åŠ é”çš„æ•ˆæœå´ä¸åŒã€‚å› ä¸ºæ˜ç¡®åŠ äº† limit 2 çš„é™åˆ¶ï¼Œå› æ­¤åœ¨éå†åˆ° (c=10, id=30) è¿™ä¸€è¡Œä¹‹åï¼Œæ»¡è¶³æ¡ä»¶çš„è¯­å¥å·²ç»æœ‰ä¸¤æ¡ï¼Œå¾ªç¯å°±ç»“æŸäº†ã€‚
  - å› æ­¤ï¼Œç´¢å¼• c ä¸Šçš„åŠ é”èŒƒå›´å°±å˜æˆäº†ä»ï¼ˆc=5,id=5) åˆ°**ï¼ˆc=10,id=30)** è¿™ä¸ªå‰å¼€åé—­åŒºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YTY4MWUzOWUwYzI3Yzk4ZGNmYzhkNGFlOTdhZTUwYzFfR28ycjBCbUxxS0JpTmlzTGVwbFBsTUJSNTRjQUFNU1pfVG9rZW46Ym94Y240aUlvdEtmTDI0c0xLcHBXbTRXeU1iXzE2MzE4NzAyMDA6MTYzMTg3MzgwMF9WNA)

è¿™ä¸ªä¾‹å­å¯¹æˆ‘ä»¬å®è·µçš„æŒ‡å¯¼æ„ä¹‰å°±æ˜¯ï¼Œ**åœ¨åˆ é™¤æ•°æ®çš„æ—¶å€™å°½é‡åŠ  limit**ã€‚è¿™æ ·ä¸ä»…å¯ä»¥æ§åˆ¶åˆ é™¤æ•°æ®çš„æ¡æ•°ï¼Œè®©æ“ä½œæ›´å®‰å…¨ï¼Œè¿˜å¯ä»¥å‡å°åŠ é”çš„èŒƒå›´ã€‚



## Case 3 ä¸»é”®è‡ªå¢

ä¸€ä¸ªæ–°çš„è¡¨

```
CREATE TABLE z (

  id INT PRIMARY KEY AUTO_INCREMENT,

  b INT,

  KEY b(b)

)ENGINE = InnoDB DEFAULT CHARSET = utf8;



INSERT INTO z (id, b)

VALUES (1, 2),(3, 4),(5, 6),(7, 8),(9, 10);
```

| Session A                                      | Session B                             |
| ---------------------------------------------- | ------------------------------------- |
| BEGIN; SELECT * FROM z WHERE b = 6 FOR UPDATE; | INSERT INTO z VALUES (0, 4);(blocked) |

æ­¤æ—¶bç´¢å¼•ä¸Šçš„é”å¦‚å›¾æ‰€ç¤º

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmMwMDFhMWZiNGRmMmQyMTY4Y2VkZTc2NjI0ZGFlOGVfNHR5NXBIYk4wM1Z2VUI2Ykt4R0RsRUFhR2ZDRHpnS3pfVG9rZW46Ym94Y25BRFE4djF0b3pYOGpTTk5XTWZXN3VlXzE2MzE4NzAyMDA6MTYzMTg3MzgwMF9WNA)

è¿™é‡ŒSession B é—®ä»€ä¹ˆä¼šé”ä½?

- åœ¨ session A ä¸­å°è¯•æ’å…¥ (b=4, id=0)å¹¶æŸ¥è¯¢ç»“æœï¼š

```
INSERT INTO z VALUES (0, 4);



SELECT * FROM z;
```

- æ­¤æ—¶ï¼Œå‘ç°è¡¨ä¸­å¹¶æ²¡æœ‰å‘ç° (b=4, id=0)è¿™æ¡è®°å½•ï¼Œä½†æ˜¯å¤šäº† (b=4,id=10)è¿™æ¡ï¼›æ‰€ä»¥æ’å…¥ (b=4, id=0)çš„æ—¶å€™çœŸæ­£æ’å…¥çš„æ˜¯ (b=4,id=10)è¿™ä¸ªå€¼ï¼›è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šä¸»é”® id çš„å€¼ `AUTO INCREMENT`ï¼Œå½“æ’å…¥çš„ä¸»é”®å€¼ä¸º0çš„æ—¶å€™ï¼Œä¼šè¢«æ›¿æ¢ä¸º `AUTO_INCREMENT`çš„å€¼ï¼Œå³10

- å¯¹æ­¤ï¼ŒMySQL å®˜æ–¹æ–‡æ¡£ä¸­çš„è§£é‡Šæ˜¯ï¼šåœ¨é `NO_AUTO_VALUE_ON_ZERO`æ¨¡å¼ä¸‹ï¼Œç»™è‡ªå¢çš„åˆ—èµ‹å€¼ä¸º 0ï¼Œéƒ½ä¼šè¢«æ›¿æ¢ä¸ºè‡ªå¢åºåˆ—çš„ä¸‹ä¸€ä¸ªå€¼ï¼›å½“è¯¥è‡ªå¢åˆ—å€¼æŒ‡å®š NOT NULL æ—¶èµ‹å€¼ NULLï¼Œä¹Ÿä¼šè¢«æ›¿æ¢ï¼›å½“æ’å…¥å…¶ä»–å€¼æ—¶ï¼Œè‡ªå¢åºåˆ—çš„å€¼ä¼šè¢«æ›¿æ¢ä¸ºå½“å‰åˆ—ä¸­æœ€å¤§å€¼çš„ä¸‹ä¸€ä¸ªå€¼ï¼›å‚è€ƒ [MySQL 8.0 Reference Manual æ–‡æ¡£ï¼ŒTutorial çš„ Examples of Common Queries , 3.6.9 Using AUTO_INCREMENT](https://dev.mysql.com/doc/refman/8.0/en/example-auto-increment.html)



## Case 4 in åŠ é”åˆ†æ

- Sql: select id from t where c in(5,20,10) lock in share mode;
- åˆ†æï¼šè¿™æ¡æŸ¥è¯¢è¯­å¥é‡Œç”¨çš„æ˜¯ inï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹è¿™æ¡è¯­å¥çš„ explain ç»“æœã€‚

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MmI0MzIwN2Q4MzQyZDRlODU0M2QwYzVjYWYzMTU3MmVfZWJpMXp3WW5rVWtDUUlQNlpjYmo3aDdoT2xPdE1tS0pfVG9rZW46Ym94Y25RYzZtWno2ekhRbzdHbFEyQ210QzRjXzE2MzE4NzAyMDA6MTYzMTg3MzgwMF9WNA)

- å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¡ in è¯­å¥ä½¿ç”¨äº†ç´¢å¼• c å¹¶ä¸” rows=3ï¼Œè¯´æ˜è¿™ä¸‰ä¸ªå€¼éƒ½æ˜¯é€šè¿‡ B+ æ ‘æœç´¢å®šä½çš„ã€‚
- åœ¨æŸ¥æ‰¾ c=5 çš„æ—¶å€™ï¼Œå…ˆé”ä½äº† (0,5]ã€‚ä½†æ˜¯å› ä¸º c ä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸ºäº†ç¡®è®¤è¿˜æœ‰æ²¡æœ‰åˆ«çš„è®°å½• c=5ï¼Œå°±è¦å‘å³éå†ï¼Œæ‰¾åˆ° c=10 æ‰ç¡®è®¤æ²¡æœ‰äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹æ»¡è¶³ä¼˜åŒ– 2ï¼Œæ‰€ä»¥åŠ äº†é—´éš™é” (5,10)ã€‚
- åŒæ ·çš„ï¼Œæ‰§è¡Œ c=10 è¿™ä¸ªé€»è¾‘çš„æ—¶å€™ï¼ŒåŠ é”çš„èŒƒå›´æ˜¯ (5,10] å’Œ (10,15)ï¼›æ‰§è¡Œ c=20 è¿™ä¸ªé€»è¾‘çš„æ—¶å€™ï¼ŒåŠ é”çš„èŒƒå›´æ˜¯ (15,20] å’Œ (20,25)ã€‚
- é€šè¿‡è¿™ä¸ªåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¿™æ¡è¯­å¥åœ¨ç´¢å¼• c ä¸ŠåŠ çš„ä¸‰ä¸ªè®°å½•é”çš„é¡ºåºæ˜¯ï¼šå…ˆåŠ  c=5 çš„è®°å½•é”ï¼Œå†åŠ  c=10 çš„è®°å½•é”ï¼Œæœ€ååŠ  c=20 çš„è®°å½•é”ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™äº›é”æ˜¯â€œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸€ä¸ªä¸€ä¸ªåŠ çš„â€



## Case 5 é—´éš™é”æ˜¯åŠ¨æ€çš„

| Session A                                                    | Session B                                                    |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| Begin; Select c from t where id > 10 and id <=15 for update; |                                                              |
|                                                              | Delete from t where id = 10; (Query OK) Insert Into t values(10,10,10); (Blocked) |

å¯ä»¥åˆ†æå‡ºï¼ŒSession Aä¼šåœ¨ç´¢å¼• id ä¸ŠåªåŠ  (10,15]è¿™ä¸ª next-key lock

ç”±äº session A å¹¶æ²¡æœ‰é”ä½ c=10 è¿™ä¸ªè®°å½•ï¼Œæ‰€ä»¥ session B åˆ é™¤ id=10 è¿™ä¸€è¡Œæ˜¯å¯ä»¥çš„ã€‚ä½†æ˜¯ä¹‹åï¼Œsession B å†æƒ³ insert id=10 è¿™ä¸€è¡Œå›å»å°±ä¸è¡Œäº†ã€‚

è¿™æ˜¯å› ä¸ºdelete æ“ä½œæŠŠ id=10 è¿™ä¸€è¡Œåˆ æ‰äº†ï¼Œ**åŸæ¥çš„ä¸¤ä¸ªé—´éš™ (5,10)ã€(10,15ï¼‰å˜æˆäº†ä¸€ä¸ª (5,15)ã€‚**

å³æ­¤æ—¶Session AæŒæœ‰çš„next-key lockå˜æˆäº†(5ï¼Œ15]

**ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€è°“â€œé—´éš™â€ï¼Œå…¶å®æ ¹æœ¬å°±æ˜¯ç”±â€œè¿™ä¸ªé—´éš™å³è¾¹çš„é‚£ä¸ªè®°å½•â€å®šä¹‰çš„**



# **æ­»é”åŸç†ä¸åˆ†æ**

 æ·±å…¥ç†è§£MySQLå¦‚ä½•åŠ é”ï¼Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä½œç”¨ï¼š

-  å¯ä»¥æ ¹æ®MySQLçš„åŠ é”è§„åˆ™ï¼Œå†™å‡ºä¸ä¼šå‘ç”Ÿæ­»é”çš„SQLï¼›

-  å¯ä»¥æ ¹æ®MySQLçš„åŠ é”è§„åˆ™ï¼Œå®šä½å‡ºçº¿ä¸Šäº§ç”Ÿæ­»é”çš„åŸå› ï¼›

 

 ä¸‹é¢ï¼Œæ¥çœ‹çœ‹ä¸¤ä¸ªæ­»é”çš„ä¾‹å­ (ä¸€ä¸ªæ˜¯ä¸¤ä¸ªSessionçš„ä¸¤æ¡SQLäº§ç”Ÿæ­»é”ï¼›å¦ä¸€ä¸ªæ˜¯ä¸¤ä¸ªSessionçš„ä¸€æ¡SQLï¼Œäº§ç”Ÿæ­»é”)ï¼š

 

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=Yzc2ZjlmOTZiMjJkZjJjNTU4YThiNzEzMDc3NzVjZDRfaE9BVFV1SUhXRHBDWmF4UFJtVWpuVnVwMkQ1ZUJTMHNfVG9rZW46Ym94Y25wU0t0MlJhaWNNUXBtdzM2OUtveE1kXzE2MzE4NzAyMTg6MTYzMTg3MzgxOF9WNA)

 

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=YzY5NzliNTBhMjA0MWFjMTBkYTE0YTFhNmJjZTQzNzhfd2NoeWd2bEVUMkRQMFZhWjA5dFA3UkJvSGFPNGduODdfVG9rZW46Ym94Y256ZUYweWJORThTRlB4R1pjNzBVeWhlXzE2MzE4NzAyMTg6MTYzMTg3MzgxOF9WNA)



 ä¸Šé¢çš„ä¸¤ä¸ªæ­»é”ç”¨ä¾‹ã€‚ç¬¬ä¸€ä¸ªéå¸¸å¥½ç†è§£ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§çš„æ­»é”ï¼Œæ¯ä¸ªäº‹åŠ¡æ‰§è¡Œä¸¤æ¡SQLï¼Œåˆ†åˆ«æŒæœ‰äº†ä¸€æŠŠé”ï¼Œç„¶ååŠ å¦ä¸€æŠŠé”ï¼Œäº§ç”Ÿæ­»é”ã€‚

  

 ç¬¬äºŒä¸ªç”¨ä¾‹ï¼Œè™½ç„¶æ¯ä¸ªSessionéƒ½åªæœ‰ä¸€æ¡è¯­å¥ï¼Œä»æ—§ä¼šäº§ç”Ÿæ­»é”ã€‚è¦åˆ†æè¿™ä¸ªæ­»é”ï¼Œé¦–å…ˆå¿…é¡»ç”¨åˆ°æœ¬æ–‡å‰é¢æåˆ°çš„MySQLåŠ é”çš„è§„åˆ™ã€‚é’ˆå¯¹Session 1ï¼Œä»nameç´¢å¼•å‡ºå‘ï¼Œè¯»åˆ°çš„[hdc, 1]ï¼Œ[hdc, 6]å‡æ»¡è¶³æ¡ä»¶ï¼Œä¸ä»…ä¼šåŠ nameç´¢å¼•ä¸Šçš„è®°å½•Xé”ï¼Œè€Œä¸”ä¼šåŠ èšç°‡ç´¢å¼•ä¸Šçš„è®°å½•Xé”ï¼ŒåŠ é”é¡ºåºä¸ºå…ˆ[1,hdc,100]ï¼Œå[6,hdc,10]ã€‚è€ŒSession 2ï¼Œä»pubtimeç´¢å¼•å‡ºå‘ï¼Œ[10,6],[100,1]å‡æ»¡è¶³è¿‡æ»¤æ¡ä»¶ï¼ŒåŒæ ·ä¹Ÿä¼šåŠ èšç°‡ç´¢å¼•ä¸Šçš„è®°å½•Xé”ï¼ŒåŠ é”é¡ºåºä¸º[6,hdc,10]ï¼Œå[1,hdc,100]ã€‚å‘ç°æ²¡æœ‰ï¼Œè·ŸSession 1çš„åŠ é”é¡ºåºæ­£å¥½ç›¸åï¼Œå¦‚æœä¸¤ä¸ªSessionæ°å¥½éƒ½æŒæœ‰äº†ç¬¬ä¸€æŠŠé”ï¼Œè¯·æ±‚åŠ ç¬¬äºŒæŠŠé”ï¼Œæ­»é”å°±å‘ç”Ÿäº†ã€‚

  

 **ç»“è®ºï¼š**æ­»é”çš„å‘ç”Ÿä¸å¦ï¼Œå¹¶ä¸åœ¨äºäº‹åŠ¡ä¸­æœ‰å¤šå°‘æ¡SQLè¯­å¥ï¼Œ**æ­»é”çš„å…³é”®åœ¨äº**ï¼šä¸¤ä¸ª(æˆ–ä»¥ä¸Š)çš„Session**åŠ é”çš„é¡ºåº**ä¸ä¸€è‡´ã€‚è€Œä½¿ç”¨æœ¬æ–‡ä¸Šé¢æåˆ°çš„ï¼Œåˆ†æMySQLæ¯æ¡SQLè¯­å¥çš„åŠ é”è§„åˆ™ï¼Œåˆ†æå‡ºæ¯æ¡è¯­å¥çš„åŠ é”é¡ºåºï¼Œç„¶åæ£€æŸ¥å¤šä¸ªå¹¶å‘SQLé—´æ˜¯å¦å­˜åœ¨ä»¥ç›¸åçš„é¡ºåºåŠ é”çš„æƒ…å†µï¼Œå°±å¯ä»¥åˆ†æå‡ºå„ç§æ½œåœ¨çš„æ­»é”æƒ…å†µï¼Œä¹Ÿå¯ä»¥åˆ†æå‡ºçº¿ä¸Šæ­»é”å‘ç”Ÿçš„åŸå› ã€‚



# **ä¸€æ¡å¤æ‚çš„****SQL****åŠ é”åˆ†æ**



 å…¶å®MySQLçš„åŠ é”å®ç°å·²ç»ä»‹ç»çš„å…«å…«ä¹ä¹ã€‚åªè¦æ ¹æ®æœ¬æ–‡ä¸Šé¢çš„åˆ†ææ€è·¯ï¼Œå¤§éƒ¨åˆ†çš„SQLï¼Œéƒ½èƒ½åˆ†æå‡ºå…¶ä¼šåŠ å“ªäº›é”ã€‚è€Œè¿™é‡Œï¼Œå†æ¥çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ç‚¹çš„SQLï¼Œç”¨äºè¯´æ˜MySQLåŠ é”çš„å¦å¤–ä¸€ä¸ªé€»è¾‘ã€‚SQLç”¨ä¾‹å¦‚ä¸‹ï¼š

 

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NDE2YWVmMmE0MjQxOTJkMTMwYjhjNjkwNmZlNzYyYzVfenU2OTl1eWtkemg4a3diR3JFajYyejdMaG5ydHZRd2pfVG9rZW46Ym94Y25BaUcyMzlJVUp2aGdXMllycHRKQnZmXzE2MzE4NzAyMTg6MTYzMTg3MzgxOF9WNA)

 å¦‚å›¾ä¸­çš„SQLï¼Œä¼šåŠ ä»€ä¹ˆé”ï¼Ÿå‡å®šåœ¨Repeatable Readéš”ç¦»çº§åˆ«ä¸‹ï¼ŒåŒæ—¶ï¼Œå‡è®¾SQLèµ°çš„æ˜¯idx_t1_puç´¢å¼•ã€‚

  

 åœ¨è¯¦ç»†åˆ†æè¿™æ¡SQLçš„åŠ é”æƒ…å†µå‰ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªçŸ¥è¯†å‚¨å¤‡ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªSQLä¸­çš„whereæ¡ä»¶å¦‚ä½•æ‹†åˆ†ï¼Ÿ

  

-  **Index keyï¼š**pubtime > 1 and puptime < 20ã€‚æ­¤æ¡ä»¶ï¼Œç”¨äºç¡®å®šSQLåœ¨idx_t1_puç´¢å¼•ä¸Šçš„æŸ¥è¯¢èŒƒå›´ã€‚ 

-  **Index Filterï¼š**userid = â€˜hdcâ€™ ã€‚æ­¤æ¡ä»¶ï¼Œå¯ä»¥åœ¨idx_t1_puç´¢å¼•ä¸Šè¿›è¡Œè¿‡æ»¤ï¼Œä½†ä¸å±äºIndex Keyã€‚

-  **Table Filterï¼š**comment is not NULLã€‚æ­¤æ¡ä»¶ï¼Œåœ¨idx_t1_puç´¢å¼•ä¸Šæ— æ³•è¿‡æ»¤ï¼Œåªèƒ½åœ¨èšç°‡ç´¢å¼•ä¸Šè¿‡æ»¤ï¼ˆè¿”å›ç»™MySQL serverï¼Œåœ¨MySQL serverå±‚è¿‡æ»¤ï¼‰ã€‚

  

 åœ¨åˆ†æå‡ºSQL whereæ¡ä»¶çš„æ„æˆä¹‹åï¼Œå†æ¥çœ‹çœ‹è¿™æ¡SQLçš„åŠ é”æƒ…å†µ (RRéš”ç¦»çº§åˆ«)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

 

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=NWFmMjY3MDMyY2Y5OGYyNWI3OGY5ZGVlODc0NTAyZWRfczJwRHhYTUFMeGFUVFhTUmVhclBuVVFJMDRzVWRqVXBfVG9rZW46Ym94Y25lVW5wOWlLNm5iRXFtTGZ1dEFKSXlkXzE2MzE4NzAyMTg6MTYzMTg3MzgxOF9WNA)

 ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨Repeatable Readéš”ç¦»çº§åˆ«ä¸‹ï¼Œç”±Index Keyæ‰€ç¡®å®šçš„èŒƒå›´ï¼Œè¢«åŠ ä¸Šäº†GAPé”ï¼›Index Filterç»™å®šçš„æ¡ä»¶ (userid = â€˜hdcâ€™)ä½•æ—¶è¿‡æ»¤ï¼Œè§†MySQLçš„ç‰ˆæœ¬è€Œå®šï¼Œåœ¨MySQL 5.6ç‰ˆæœ¬ä¹‹å‰ï¼Œä¸æ”¯æŒ[Index Condition Pushdown](http://dev.mysql.com/doc/refman/5.6/en/index-condition-pushdown-optimization.html)(ICP)ï¼Œå› æ­¤Index Filteråœ¨MySQL Serverå±‚è¿‡æ»¤ï¼Œåœ¨5.6åæ”¯æŒäº†Index Condition Pushdownï¼Œåˆ™åœ¨indexä¸Šè¿‡æ»¤ã€‚è‹¥ä¸æ”¯æŒICPï¼Œä¸æ»¡è¶³Index Filterçš„è®°å½•ï¼Œä¹Ÿéœ€è¦åŠ ä¸Šè®°å½•Xé”ï¼Œè‹¥æ”¯æŒICPï¼Œåˆ™ä¸æ»¡è¶³Index Filterçš„è®°å½•ï¼Œæ— éœ€åŠ è®°å½•Xé” (å›¾ä¸­ï¼Œç”¨çº¢è‰²ç®­å¤´æ ‡å‡ºçš„Xé”ï¼Œæ˜¯å¦è¦åŠ ï¼Œè§†æ˜¯å¦æ”¯æŒICPè€Œå®š)ï¼›è€ŒTable Filterå¯¹åº”çš„è¿‡æ»¤æ¡ä»¶ï¼Œåˆ™åœ¨èšç°‡ç´¢å¼•ä¸­è¯»å–åï¼Œåœ¨MySQL Serverå±‚é¢è¿‡æ»¤ï¼Œå› æ­¤èšç°‡ç´¢å¼•ä¸Šä¹Ÿéœ€è¦Xé”ã€‚

  

 **ç»“è®ºï¼š**åœ¨Repeatable Readéš”ç¦»çº§åˆ«ä¸‹ï¼Œé’ˆå¯¹ä¸€ä¸ªå¤æ‚çš„SQLï¼Œé¦–å…ˆéœ€è¦æå–å…¶whereæ¡ä»¶ã€‚Index Keyç¡®å®šçš„èŒƒå›´ï¼Œéœ€è¦åŠ ä¸ŠGAPé”ï¼›Index Filterè¿‡æ»¤æ¡ä»¶ï¼Œè§†MySQLç‰ˆæœ¬æ˜¯å¦æ”¯æŒICPï¼Œè‹¥æ”¯æŒICPï¼Œåˆ™ä¸æ»¡è¶³Index Filterçš„è®°å½•ï¼Œä¸åŠ Xé”ï¼Œå¦åˆ™éœ€è¦Xé”ï¼›Table Filterè¿‡æ»¤æ¡ä»¶ï¼Œæ— è®ºæ˜¯å¦æ»¡è¶³ï¼Œéƒ½éœ€è¦åŠ Xé”ã€‚



å¦‚æœä¸€æ¡sql explain åçš„extraåˆ—æ˜¾ç¤ºUsing index conditionï¼Œé‚£ä¹ˆå¯ä»¥ç¡®å®šä½¿ç”¨äº†Index Condition Pushdownä¼˜åŒ–



```
CREATE TABLE `t1` (

  `id` int NOT NULL,

  `userid` varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL,

  `blogId` varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL,

  `comment` varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL,

  `pubtime` int NOT NULL,

  PRIMARY KEY (`id`),

  KEY `ix` (`pubtime`,`userid`)

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



insert into t1 values(1,"hdc","a", null, 10);

insert into t1 values(4,"yyy","b", null, 3);

insert into t1 values(6,"hdc","c", null, 100);

insert into t1 values(8,"hdc","d", "good", 5);

insert into t1 values(10,"hdc","e", null, 1);

insert into t1 values(100,"bbb","f", null, 20);
```

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=MzE2YzNmNzdjYWYyZDUxNmFhMzk2ZTBhODU1NWFmN2ZfTEpUdFFzS0VRVG4yN1BwTDJic0tRMjJRNlduNWgwc1NfVG9rZW46Ym94Y25QZEEzV3d5MXdOa1RZaGxWYURWVlJpXzE2MzE4NzAyMTg6MTYzMTg3MzgxOF9WNA)

![img](https://bytedance.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTE5NTNhNmIwNWFmZTM2MzIyM2JlMzA0ZDFjNWZkYjFfR3pSM1VkV3BFblpQT3ZJVHV0ZWxBN2dMa0tTc25mSDFfVG9rZW46Ym94Y25JYXBFTDY2UjBEakhYZTBra0l0QkdoXzE2MzE4NzAyMTg6MTYzMTg3MzgxOF9WNA)

Mysql 8.0.25å®è·µ,sqlä½¿ç”¨äº†index condition pushdown,ä½†æ˜¯ä¸æ»¡è¶³index_filterçš„è®°å½•(pubtime = 3, userId = 'yyy',id = 4)è¿˜æ˜¯ä¼šåŠ xé”ï¼Œä½†æ˜¯è¿™äº›è®°å½•å¯¹åº”çš„ä¸»é”®(id =4)ä¸ä¼šåŠ xé”ï¼Œè€Œä¸”(pubtime =20ï¼ŒuserId = 'bbb', id = 100)ä¹Ÿä¼šåŠ è¡Œé”,å¯¹åº”çš„id = 100ä¸ä¼šåŠ xé”ï¼Œç¬¦åˆä¸Šé¢çš„åŠ é”è§„åˆ™ï¼ˆåŸåˆ™ä¸€ï¼ŒåŸåˆ™äºŒï¼‰